{% extends 'layout.html' %}
{% from 'components/form_macros.html' import render_field, render_select_field, render_checkbox, render_submit %}

{% block title %}{{ title }}{% endblock %}

{% block content_header %}
<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>{{ title }}</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{{ url_for('dashboard.show_dashboard') }}">Inicio</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('personal.index') }}">Personal</a></li>
          <li class="breadcrumb-item active">{{ legend }}</li>
        </ol>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="card shadow-sm rounded-4">
  <!-- COMENTARIO: Se aplica el estilo del encabezado de index.html para consistencia. -->
  <div class="card-header bg-dark text-white rounded-top-4">
    <h3 class="card-title mb-0">{{ legend }}</h3>
  </div>
  <form method="POST" enctype="multipart/form-data" novalidate>
    {{ form.hidden_tag() }}
    <div class="card-body">

      <h5 class="text-muted mt-2 mb-3"><i class="fas fa-user-circle me-2"></i>Información Personal</h5>
      <div class="row">
        <div class="col-md-6">{{ render_field(form.nombre, placeholder="Nombre de la persona") }}</div>
        <div class="col-md-6">{{ render_field(form.apellido, placeholder="Apellido de la persona") }}</div>
      </div>

      <div class="row">
        <div class="col-md-6">{{ render_field(form.rut, placeholder="12.345.678-9") }}</div>
        <div class="col-md-6">{{ render_field(form.direccion, placeholder="Calle, número, comuna") }}</div>
      </div>

      <hr>

      <h5 class="text-muted mt-4 mb-3"><i class="fas fa-address-book me-2"></i>Información de Contacto</h5>
      <div class="row">
        <div class="col-md-6">{{ render_field(form.email, type="email", placeholder="ejemplo@dominio.com") }}</div>
        <div class="col-md-6">{{ render_field(form.celular_personal, placeholder="+56 9 1234 5678") }}</div>
      </div>

      <div class="row">
        <div class="col-md-6">{{ render_field(form.persona_contacto, placeholder="Nombre de contacto de emergencia") }}</div>
        <div class="col-md-6">{{ render_field(form.celular_contacto, placeholder="Celular de emergencia") }}</div>
      </div>

      <hr>

      <h5 class="text-muted mt-4 mb-3"><i class="fas fa-briefcase me-2"></i>Información Laboral y Documentos</h5>
      <div class="row">
        <!-- COMENTARIO: Se añade la clase 'select2-enable' para que el campo sea un buscador. -->
        <div class="col-md-6">{{ render_select_field(form.cargo_id, class='form-select select2-enable') }}</div>
        <!-- COMENTARIO: Se añade el campo para seleccionar la faena, también con búsqueda. -->
        <div class="col-md-6">{{ render_select_field(form.bodega_id, class='form-select select2-enable') }}</div>
      </div>
      <div class="row">
        <div class="col-md-6">{{ render_field(form.firma_imagen, type="file") }}</div>
      </div>

      <div class="row">
        <div class="col-md-6">{{ render_field(form.fecha_vencimiento_licencia, type="date") }}</div>
        <div class="col-md-6">{{ render_field(form.fecha_vencimiento_cedula, type="date") }}</div>
      </div>

      <hr>

      <h5 class="text-muted mt-4 mb-3"><i class="fas fa-cogs me-2"></i>Configuración del Sistema</h5>
      <div class="row mb-3">
        <div class="col-md-3">{{ render_checkbox(form.activo) }}</div>
        <div class="col-md-3">{{ render_checkbox(form.tiene_login, id="tiene_login") }}</div>
      </div>

      <div id="login-fields" style="display: {{ 'block' if form.tiene_login.data else 'none' }};">
        <h5 class="text-muted mt-4 mb-3"><i class="fas fa-key me-2"></i>Datos de Acceso</h5>
        <div class="row">
          <div class="col-md-4">{{ render_field(form.username) }}</div>
          <div class="col-md-4">{{ render_field(form.password, type="password") }}</div>
          <div class="col-md-4">{{ render_field(form.confirm_password, type="password") }}</div>
        </div>
        <div class="row">
          <div class="col-md-6">{{ render_select_field(form.rol_id) }}</div>
        </div>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-between">
      {{ form.submit(class="btn btn-primary") }}
      <a href="{{ url_for('personal.index') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // --- Lógica para mostrar/ocultar campos de login ---
    const tieneLoginCheckbox = document.getElementById('tiene_login');
    const loginFieldsDiv = document.getElementById('login-fields');
  
    function toggleLoginFields() {
      loginFieldsDiv.style.display = tieneLoginCheckbox.checked ? 'block' : 'none';
    }
  
    tieneLoginCheckbox.addEventListener('change', toggleLoginFields);

    // --- Inicialización de Select2 para los campos de Cargo y Faena ---
    $('.select2-enable').each(function() {
      $(this).select2({
        theme: 'bootstrap-5',
        // dropdownParent asegura que el menú desplegable se muestre correctamente
        // sin ser cortado por los bordes de la tarjeta (card).
        dropdownParent: $(this).parent()
      });
    });
  });
</script>
{% endblock %}
