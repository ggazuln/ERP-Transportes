<aside class="main-sidebar sidebar-dark-primary elevation-4">
  <!-- Logo y nombre del usuario -->
  <a href="{{ url_for('dashboard.show_dashboard') }}" class="brand-link">
    {% if empresa_logo %}
    <img src="{{ url_for('static', filename='img/' ~ empresa_logo ~ '.png') }}" alt="Logo Empresa"
      class="brand-image img-circle elevation-3" style="opacity: .8;">
    {% endif %}
    <span class="brand-text font-weight-light">
      <strong>{{ current_user.username }}</strong>
    </span>
  </a>

  <!-- Sidebar -->
  <div class="sidebar">
    <nav class="mt-2">
      <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">

        <!-- Menú inicio -->
        <li class="nav-item">
          <a href="{{ url_for('dashboard.show_dashboard') }}" class="nav-link {{ 'active' if request.endpoint == 'dashboard.show_dashboard' else '' }}">
            <i class="nav-icon fas fa-home"></i>
            <p>Inicio</p>
          </a>
        </li>

        {# --- MACRO RECURSIVO PARA RENDERIZAR EL MENÚ --- #}
        {% macro render_menu(items) %}
          {% for item in items %} {# Cada 'item' es un módulo #}
            {% if item.hijos %}
              {# Es un Módulo con submódulos, se renderiza como un submenú desplegable #}
              {% set blueprint_name = item.endpoint.split('.')[0] %}
              {% set is_open = request.endpoint.startswith(blueprint_name) %}
              <li class="nav-item {{ 'menu-open' if is_open else '' }}">
                <a href="#" class="nav-link {{ 'active' if is_open else '' }}">
                  <i class="nav-icon {{ item.icono or 'fas fa-folder' }}"></i>
                  <p>
                    {{ item.nombre }}
                    <i class="right fas fa-angle-left"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  {# Llamada recursiva para los submódulos #}
                  {{ render_menu(item.hijos) }}
                </ul>
              </li>
            {% else %}
              {# Es un Módulo sin submódulos (hoja del árbol), se renderiza como un enlace simple #}
              <li class="nav-item">
                <a href="{{ safe_url_for(item.endpoint) }}" class="nav-link {{ 'active' if request.endpoint == item.endpoint else '' }}">
                  <i class="nav-icon {{ item.icono or 'far fa-circle' }}"></i>
                  <p>{{ item.nombre }}</p>
                </a>
              </li>
            {% endif %}
          {% endfor %}
        {% endmacro %}

        <!-- Menú dinámico generado por el macro -->
        {{ render_menu(menu_lateral) }}

      </ul>
    </nav>
  </div>
</aside>